---
title: Vitest testing rules
scope:
  - "**/*.test.ts"
alwaysApply: true
---
# Vitest Test Generation Rules

You are writing tests using **Vitest** for this repository.

## Non-negotiables

1. **Minimize duplication**
   - Before creating any new helper, look for existing shared test helpers/harnesses/fixtures and reuse them.
   - If logic repeats across **2+ tests**, extract it into a shared helper in the appropriate shared test module (not inline in one test file).

2. **Prefer shared harnesses and builders (whenever applicable)**
   - **Rule:** If the code area you're testing already has a shared harness/fixture builder, you **must** use it rather than re-implementing setup or constructing entities from scratch.
   - This repository's default shared harness is `test/EventHandlers/Pool/common.ts`. Use it whenever your test uses any entities/builders/fixtures it already provides.
   - Only create new local helpers if a shared helper would not be reusable.

3. **Deterministic tests only**
   - Avoid `new Date()` in assertions and fixtures unless using fake timers.
   - Prefer fixed timestamps from shared helpers.
   - No real network/filesystem/time/randomness unless explicitly required.

4. **Readable AAA structure**
   - Use Arrange → Act → Assert.
   - Tests should read like documentation.
   - Prefer small focused tests.

5. **Checksum all mock Ethereum addresses (whenever addresses are used)**
   - Any mock Ethereum-related address (pool, token, user, contract, etc.) used in tests **must** be checksummed using `toChecksumAddress` from `src/Constants.ts`.
   - Import: `import { toChecksumAddress } from "../../src/Constants";` (adjust path as needed).
   - Use valid 40-character hex (after `0x`); invalid or non-hex strings will throw at runtime.
   - Do **not** use raw lowercase/uppercase address strings in mocks, fixtures, or assertions when the value represents an address.

---

## Envio / MockDb and processEvents

- **Event processing in tests:** Use `mockDb.processEvents([event])` (or the relevant db variable). The deprecated `Contract.Event.processEvent({ event, mockDb })` must not be used.
- **Handler registration:** Any test file that calls `*.processEvents()` **must** import the registration module so all handlers are registered:
  ```ts
  import "../eventHandlersRegistration";  // from test/EventHandlers/*.test.ts
  import "../../eventHandlersRegistration"; // from test/EventHandlers/**/*.test.ts
  ```
- **Event mocks:** Use the generated mock API (e.g. `NFPM.Transfer.createMockEvent({ ... })`, `Pool.Mint.createMockEvent({ ... })`) so events are valid for `processEvents`.

---

## Shared test harness rules

### `common.ts` harness (repo-wide, whenever applicable)

This repository provides a shared test harness in `test/EventHandlers/Pool/common.ts`.  
Despite the path name, it contains reusable fixtures/builders that are applicable to many tests.

**Rule (whenever applicable):**
- If your test needs any of the entities/fixtures/builders provided by this harness, you **must** use it instead of constructing objects from scratch.
- Prefer `common.createMock*` builders whenever you need variants — even for a one-field change — to keep derived fields (like `id`) correct.

#### Required import + initialization

```ts
import { setupCommon } from "./common"; // use "../common" or "../../common" for nested subdirectories

let common: ReturnType<typeof setupCommon>;

beforeEach(() => {
  common = setupCommon();
});
```

**Mandatory reuse of fixtures/builders**

Use these from `common` instead of creating objects from scratch (not complete list, just examples):

- `common.mockToken0Data`
- `common.mockToken1Data`
- `common.mockLiquidityPoolData`
- `common.mockALMLPWrapperData`
- `common.mockUserStatsPerPoolData`
- `common.mockVeNFTStateData`
- `common.mockVeNFTPoolVoteData`
- `common.mockNonFungiblePositionData`
- `common.createMockUserStatsPerPool(overrides)`
- `common.createMockLiquidityPoolAggregator(overrides)`
- `common.createMockVeNFTState(overrides)`
- `common.createMockVeNFTPoolVote(overrides)`
- `common.createMockNonFungiblePosition(overrides)`
- `common.createMockContext(entities)`

**Object creation rules**

- Never construct `Token`, `LiquidityPoolAggregator`, `UserStatsPerPool`, `VeNFTState`, `VeNFTPoolVote` from scratch inside a test if `setupCommon()` already provides a mock or builder.
- If you need variants, use the `createMock*` builders with `Partial<T>` overrides.
- If a builder doesn't exist but would be broadly useful, add it to `common.ts` rather than writing local one-off helpers.

**Correct override patterns**

Use builder overrides so derived fields (like `id`) stay correct:

```ts
const pool = common.createMockLiquidityPoolAggregator({
  reserve0: 500n,
  chainId: 10,
});
const user = common.createMockUserStatsPerPool({
  userAddress: toChecksumAddress("0x0000000000000000000000000000000000000abc"),
  totalFeesContributedUSD: 123n,
});
```

**Helper placement rule**

- If the helper is **broadly reusable** across the repository's tests, add it to:
  - `test/EventHandlers/Pool/common.ts`
- If the helper is **truly domain-specific** and would confuse unrelated tests, add it to a domain-local module (e.g. `test/<Domain>/common.ts`) and keep `Pool/common.ts` focused on shared primitives.

## Test structure and style

### Naming
- `describe("<unit under test>")`
- `test("should <expected> when <condition>")`

Avoid vague names like “works” or “handles”.

### Table-driven tests

Prefer `test.each` for scenario matrices:

```ts
test.each([
  ["case name", inputA, inputB, expected],
])("should do X (%s)", async (_name, a, b, expected) => {
  // Arrange
  // Act
  // Assert
});
```

### Mocking

- Mock only boundaries (DB, network, filesystem, third-party SDKs).

- Prefer dependency injection over `vi.mock()` where possible.

- Use Vitest APIs: `vi.mock()`, `vi.fn()`, `vi.spyOn()`, `vi.mocked()`, `vi.restoreAllMocks()`, `vi.restoreAllMocks()`.

- If using spies/mocks in a suite, reset consistently:

```ts
beforeEach(() => {
  vi.restoreAllMocks();
});
```

- Prefer top-level imports and `vi.mocked(module.fn)` for assertions; avoid `vi.resetModules()` and dynamic `await import()` unless necessary (they are rarely needed with Vitest mocks).

### Assertions

- Assert behavior and outputs first.

- Use `toMatchObject` for partial matches when extra fields are noisy.

- Avoid snapshots unless output is large and stable.

### “Stop and centralize” rule

When writing a new test, if you find yourself:

- copying large object literals,

- repeating the same calculations,

- repeating the same assertions,

- repeating setup boilerplate,

Stop and refactor:

- If the helper is broadly reusable, add it to `test/EventHandlers/Pool/common.ts`.
- If the helper is domain-specific and would confuse unrelated tests, add it to a domain-local module (e.g. `test/<Domain>/common.ts`).